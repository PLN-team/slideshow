```{r setup-oaks, include=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)  # data manipulation
library(PLNmodels)  # plot of covariance/correlation matrices
library(corrplot)   # plot of covariance/correlation matrices
```

```{r future, echo = FALSE}
options(future.fork.enable = TRUE)
future::plan("multicore", workers = 10)
```

---

# Illustration in genomics

## scRNA data set 

The dataset `scRNA` contains the counts of the 500 most varying transcripts in the mixtures of 5 cell lines in human liver (obtained with standard 10x scRNAseq Chromium protocol).

We subsample 500 random cells and the keep the 200 most varying genes

```{r scRNA data set}
library(PLNmodels); library(ZIPLN)
data(scRNA); set.seed(1234)
scRNA        <- scRNA[sample.int(nrow(scRNA), 500), ]
scRNA$counts <- scRNA$counts[, 1:200]
scRNA$counts %>% as_tibble() %>% rmarkdown::paged_table()
```

---

# Abundance table

.pull-left[
Data table
```{r glimpse Abundance, echo = FALSE}
data(oaks)
oaks$Abundance %>% as_tibble() %>% 
  dplyr::select(5:10) %>% 
  rmarkdown::paged_table()
```
]
.pull-right[
Matrix of count (log-scale)

```{r glance Abundances, fig.height=6, fig.cap="log-scaled counts", echo = FALSE}
log(1 + oaks$Abundance) %>% 
  corrplot::corrplot(is.corr = FALSE,
    addgrid.col = NA,  tl.cex = .5,  cl.pos = "n")
```
]

---
#  PLN with offsets and covariates (1)

## Offset: .small[modeling sampling effort]

The predefined offset uses the total sum of reads, accounting for technologies specific to fungi and bacteria:

```{r simple PLN offsets, cache = TRUE, results = FALSE}
M01_oaks <- PLN(Abundance ~ 1 + offset(log(Offset)) , oaks)
```

## Covariates: .small[tree and orientation effects ('ANOVA'-like) ]

The `tree` status is a natural candidate for explaining a part of the variance.

- We chose to describe the tree effect in the regression coefficient (mean)
- A possibly spurious effect regarding the interactions  between species (covariance).

```{r PLN covariate oaks, cache = TRUE, results = FALSE}
M11_oaks <- PLN(Abundance ~ 0 + tree + offset(log(Offset)), oaks)
```

What about adding more covariates in the model, e.g. the orientation?

```{r PLN regroup oaks modalities, cache = TRUE, results = FALSE}
M21_oaks <- PLN(Abundance ~  0 + tree + orientation + offset(log(Offset)), oaks)
```

---
#  PLN with offsets and covariates (2)

There is a clear gain in introducing the tree covariate in the model:

```{r PLN covariate oaks results}
rbind(M01 = M01_oaks$criteria,
      M11 = M11_oaks$criteria, M21 = M21_oaks$criteria) %>% 
  knitr::kable(format = "html")
```

Looking at the coefficients $\mathbf{B}$ associated with `tree` bring additional insights:

```{r oaks matrix plot, fig.width=14, fig.height=2, echo = FALSE}
coef(M11_oaks) %>% t() %>% corrplot(method = "color", is.corr = FALSE, tl.cex = 1, cl.pos = "n")
```

---

# Discriminant Analysis

Use the `tree` variable for grouping (`grouping` is a factor of group to be considered)

```{r PLNLDA oaks, results = FALSE}
myLDA_tree <- 
  PLNLDA(Abundance ~ 1 + offset(log(Offset)), grouping = oaks$tree, data = oaks)
```

.pull-left[
```{r plot oaks1, echo = FALSE, fig.height = 6}
plot(myLDA_tree, map = "individual")
```
]

.pull-right[
```{r plot oaks2, echo = FALSE, fig.height = 6}
plot(myLDA_tree, map = "variable")
```
]

---
# A PCA analysis of the oaks data set

```{r PLNPCA offset, cache.rebuild= TRUE, warning=FALSE, message=FALSE, results='hide'}
PCA_offset <- PLNPCA(Abundance ~ 1 + offset(log(Offset)), data = oaks, ranks = 1:30)
```

<small>
```{r PCA offset vizu tree, fig.width=6, fig.height=6, fig.align="center", echo=FALSE}
getBestModel(PCA_offset, "BIC") %>% factoextra::fviz_pca_biplot(
  select.var = list(contrib = 10), addEllipses = TRUE, habillage = oaks$tree,
  title = "Biplot (10 most contributing species)"
  ) + labs(col = "tree status") + scale_color_viridis_d()
```
</small>

---
# PCA: removing covariate effects

To hopefully find some hidden effects in the data, we can try to remove confounding ones:

```{r PCA covariate tree, cache.rebuild= TRUE, warning=FALSE, message=FALSE, results='hide'}
PCA_tree <- 
  PLNPCA(Abundance ~ 0 + tree + offset(log(Offset)), data = oaks, ranks = 1:30)
```

```{r PCA covariate tree plot, echo = FALSE, fig.align="center", fig.width=6, fig.height=6}
PCA_tree %>% getBestModel("BIC") %>% 
factoextra::fviz_pca_biplot(
  select.var = list(contrib = 10), col.ind = oaks$distTOground,
  title = "Biplot (10 most contributing species)"
  ) + labs(col = "distance (cm)") + scale_color_viridis_c()
```

---
# Clustering of the oaks samples

```{r PLNmixture-oaks, cache.rebuild = TRUE, results='hide'}
PLN_mixtures <-
   PLNmixture(Abundance ~ 1 + offset(log(Offset)), data = oaks, clusters = 1:3)
myPLN_mix <- getModel(PLN_mixtures, 3)
```

.pull-left[
```{r PLNclustering1fake, eval = FALSE}
myPLN_mix$plot_clustering_pca()
```

```{r PLNclustering1, echo = FALSE, fig.align='center', fig.height=6}
myPLN_mix$plot_clustering_pca(main = 'clustering memberships in individual factor map')
```
]

.pull-right[
```{r PLNclustering2, fig.align='center', fig.height=6}
myPLN_mix$plot_clustering_data()
```
]

---
# Network inference

```{r PLNnetwork, cache.rebuild= TRUE, warning=FALSE, message=FALSE, results='hide'}
networks <- PLNnetwork(Abundance ~ 0 + tree + offset(log(Offset)), data = oaks)
```

.pull-left[
```{r PLNnetwork criteria, echo = FALSE, fig.align='center', fig.height=6, warning=FALSE}
plot(networks)
```
]

.pull-right[
```{r PLNnetwork network, echo = FALSE, fig.align='center', fig.height=6, warning=FALSE}
type <- rep(c("bacterial", "fungal", "Alphiltoides"), c(66,114-67,1))
net <- fancy_network(getBestModel(networks, "EBIC"), type)
print(net)
```
]


```{r future off, echo=FALSE}
future::plan("sequential")
```

---

# Availability

### Help and documentation

- github group <https://github.com/pln-team>
- PLNmodels website <https://pln-team.github.io/PLNmodels> 

### R/C++ Package `PLNmodels`

Last stable release on CRAN,  development version available on GitHub).

```{r install, eval=FALSE, tidy=FALSE}
install.packages("PLNmodels")
remotes::install_github("PLN-team/PLNmodels@dev")
```

```{r loading package, message=FALSE}
library(PLNmodels)
packageVersion("PLNmodels")
```

### Python module `pyPLNmodels`

A Python/PyTorch implementation is available in pyPI 
[https://pypi.org/project/pyPLNmodels/](https://pypi.org/project/pyPLNmodels/)

---
# Simple torch example in `R` 

```{r, cache.rebuild=TRUE,  torch-vs-nlopt}
data("oaks")
system.time(myPLN_torch <-
              PLN(Abundance ~ 1  + offset(log(Offset)),
                  data = oaks, control = list(backend = "torch", trace = 0)))
system.time(myPLN_nlopt <-
              PLN(Abundance ~ 1  + offset(log(Offset)),
                  data = oaks, control = list(backend = "nlopt", trace = 0)))
```

```{r}
myPLN_torch$loglik
myPLN_nlopt$loglik
```

